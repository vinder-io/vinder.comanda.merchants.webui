@inject IStoreClient storeClient
@inject ILocalStorageGateway localStorage
@inject ISnackbar snackbar

<EditForm Model="@_model" OnValidSubmit="HandleSubmitAsync">
    <DataAnnotationsValidator />

    <MudPaper Elevation="0" Class="pa-6 mb-4" Style="border-radius: 12px;">
        <MudText Typo="Typo.h6" Style="font-weight: 700;" Class="mb-1">
            Integrações
        </MudText>
        <MudText Typo="Typo.body2" Style="opacity: 0.6;" Class="mb-4">
            Configure as credenciais dos serviços integrados
        </MudText>

        <MudGrid Spacing="3">
            <MudItem xs="12">
                <div class="d-flex align-center mb-2">
                    <MudIcon Icon="@Icons.Material.Outlined.Payment" Color="Color.Inherit" Size="Size.Small"
                        Class="mr-2" />
                    <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">
                        Gateway de Pagamentos - Processamento de Pagamentos
                    </MudText>
                </div>
                <MudTextField @bind-Value="_model.PaymentGatewaySecretKey" Label="Secret Key" Variant="Variant.Outlined"
                    FullWidth="true" Margin="Margin.Dense" InputType="InputType.Password" Required="true"
                    For="@(() => _model.PaymentGatewaySecretKey)"
                    HelperText="Chave secreta para processar pagamentos via AbacatePay" />
            </MudItem>

            <MudItem xs="12">
                <div class="d-flex align-center justify-space-between mb-2">
                    <div class="d-flex align-center">
                        <MudIcon Icon="@Icons.Material.Outlined.Message" Color="Color.Inherit" Size="Size.Small"
                            Class="mr-2" />
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">
                            Huggy - Mensagens WhatsApp
                        </MudText>
                    </div>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                        Em Breve
                    </MudChip>
                </div>
                <MudTextField @bind-Value="_model.WhatsappToken" Label="Token de Autenticação"
                    Variant="Variant.Outlined" FullWidth="true" Margin="Margin.Dense" Disabled="true"
                    InputType="InputType.Password" />
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <div class="d-flex justify-end gap-2">
            <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Medium" OnClick="HandleCancelAsync"
                Disabled="@_isSubmitting" Style="border-radius: 8px;">
                Cancelar
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Inherit" Size="Size.Medium"
                ButtonType="ButtonType.Submit" Disabled="@_isSubmitting" StartIcon="@Icons.Material.Outlined.Save"
                Style="border-radius: 8px;">
                @if (_isSubmitting)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Salvando...</MudText>
                }
                else
                {
                    <MudText>Salvar Alterações</MudText>
                }
            </MudButton>
        </div>
    </MudPaper>
</EditForm>

@code {
    private IntegrationCredentialsFormScheme _model = new();

    private bool _isSubmitting = false;
    private string? _establishmentId;
    private string? _paymentGatewayCredentialId;
    private string? _whatsappCredentialId;

    protected override async Task OnInitializedAsync()
    {
        await LoadCredentialsAsync();
    }

    private async Task LoadCredentialsAsync()
    {
        var establishment = await localStorage.GetAsync<EstablishmentScheme>(Storage.Establishment);
        if (establishment is null)
        {
            snackbar.Add("Estabelecimento não encontrado", Severity.Warning);
            return;
        }

        _establishmentId = establishment.Identifier;

        var result = await storeClient.GetCredentialsAsync(new() { EstablishmentId = _establishmentId });
        if (result.IsFailure || result.Data is null)
        {
            return;
        }

        foreach (var credential in result.Data)
        {
            if (credential.Provider == "PaymentGateway" || credential.Provider == IntegrationTarget.PaymentGateway.ToString())
            {
                _model.PaymentGatewaySecretKey = credential.SecretKey ?? string.Empty;
                _paymentGatewayCredentialId = credential.Identifier;
            }
            else if (credential.Provider == "Whatsapp" || credential.Provider == IntegrationTarget.Whatsapp.ToString())
            {
                _model.WhatsappToken = credential.SecretKey ?? string.Empty;
                _whatsappCredentialId = credential.Identifier;
            }
        }
    }
    private async Task HandleSubmitAsync()
    {
        if (string.IsNullOrEmpty(_establishmentId))
        {
            snackbar.Add("Estabelecimento não identificado", Severity.Error);
            return;
        }

        _isSubmitting = true;

        if (!string.IsNullOrEmpty(_model.PaymentGatewaySecretKey))
        {
            var paymentCredential = new CredentialCreationScheme
            {
                EstablishmentId = _establishmentId,
                SecretKey = _model.PaymentGatewaySecretKey,
                Provider = IntegrationTarget.PaymentGateway
            };

            var paymentResult = await storeClient.AssignIntegrationCredentialAsync(paymentCredential);
            if (paymentResult.IsFailure)
            {
                snackbar.Add($"Erro ao salvar credencial de pagamento: {paymentResult.Error.Code}", Severity.Error);
                _isSubmitting = false;

                return;
            }
        }

        snackbar.Add("Credenciais salvas com sucesso!", Severity.Success);
        _isSubmitting = false;

    }

    private async Task HandleCancelAsync()
    {
        await LoadCredentialsAsync();
        snackbar.Add("Alterações canceladas", Severity.Info);
    }
}