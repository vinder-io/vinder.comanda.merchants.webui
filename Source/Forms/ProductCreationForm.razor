@inject IStoreClient storeClient
@inject ILocalStorageGateway localStorage
@inject ISnackbar snackbar

<EditForm Model="@_model" OnValidSubmit="HandleSubmitAsync">
    <DataAnnotationsValidator />

    <MudStack Spacing="3">
        <MudTextField @bind-Value="_model.Title" Label="Título" Variant="Variant.Outlined" Class="mt-4" FullWidth="true"
            Margin="Margin.Dense" Required="true" For="@(() => _model.Title)"
            HelperText="Nome do produto que aparecerá no cardápio" />

        <MudTextField @bind-Value="_model.Description" Label="Descrição" Variant="Variant.Outlined" FullWidth="true"
            Margin="Margin.Dense" Lines="4" Required="true" For="@(() => _model.Description)"
            HelperText="Descreva os ingredientes e características" />

        <MudNumericField @bind-Value="_model.Price" Label="Preço" Variant="Variant.Outlined" FullWidth="true"
            Margin="Margin.Dense" Required="true" For="@(() => _model.Price)" Format="N2"
            Culture="@(new System.Globalization.CultureInfo("pt-BR"))" Adornment="Adornment.Start" AdornmentText="R$"
            HelperText="Valor do produto em reais" Min="0.01m" />

        @if (_imagePreview is not null)
        {
            <MudPaper Elevation="0" Class="pa-4 d-flex align-center justify-space-between"
                Style="border-radius: 8px; background: rgba(var(--mud-palette-primary-rgb), 0.05);">
                <div class="d-flex align-center gap-3">
                    <MudAvatar Size="Size.Large" Square="true" Style="border-radius: 8px;">
                        <MudImage Src="@_imagePreview" Alt="Preview"
                            Style="object-fit: cover; width: 100%; height: 100%;" />
                    </MudAvatar>
                    <div>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                            Imagem selecionada
                        </MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.7;">
                            @_selectedFileName
                        </MudText>
                    </div>
                </div>
                <MudIconButton Icon="@Icons.Material.Outlined.Close" Color="Color.Default" Size="Size.Small"
                    OnClick="@ClearImage" />
            </MudPaper>
        }
        else
        {
            <MudFileUpload T="IBrowserFile" Accept="image/*" FilesChanged="@HandleFileSelected">
                <ActivatorContent>
                    <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Outlined.Image"
                        FullWidth="true" Style="border-radius: 8px; border-style: dashed; text-transform: none;">
                        <MudText Typo="Typo.body2">
                            Adicionar imagem
                        </MudText>
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>
        }

        <MudDivider Class="my-2" />

        <div class="d-flex justify-end gap-2">
            <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@(() => OnCancel.InvokeAsync())"
                Disabled="@_isSubmitting" Style="border-radius: 8px;">
                Cancelar
            </MudButton>
            <MudButton Variant="Variant.Text" Color="Color.Primary" ButtonType="ButtonType.Submit"
                Disabled="@_isSubmitting" Style="border-radius: 8px;">
                @if (_isSubmitting)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Salvando...</MudText>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Outlined.Save" Class="me-2" />
                    <MudText>Salvar</MudText>
                }
            </MudButton>
        </div>
    </MudStack>
</EditForm>

@code {
    [Parameter]
    public EventCallback OnSuccess { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private ProductCreationFormScheme _model = new();
    private bool _isSubmitting = false;
    private byte[]? _imageBytes;
    private string? _imagePreview;
    private string? _selectedFileName;
    private string? _imageContentType;

    private async Task HandleFileSelected(IBrowserFile? file)
    {
        if (file is null)
            return;

        _selectedFileName = file.Name;
        _imageContentType = file.ContentType;

        var buffer = new byte[file.Size];
        using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);

        await stream.ReadAsync(buffer);

        _imageBytes = buffer;
        _imagePreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
    }

    private void ClearImage()
    {
        _imageBytes = null;
        _imagePreview = null;
        _selectedFileName = null;
        _imageContentType = null;
    }

    private async Task HandleSubmitAsync()
    {
        _isSubmitting = true;

        var establishment = await localStorage.GetAsync<EstablishmentScheme>(Storage.Establishment);
        if (establishment is null)
        {
            snackbar.Add("Erro ao identificar o estabelecimento", Severity.Error);
            return;
        }

        var creationScheme = new ProductCreationScheme
        {
            EstablishmentId = establishment.Identifier,
            Title = _model.Title,
            Description = _model.Description,
            Price = _model.Price
        };

        var result = await storeClient.CreateProductAsync(creationScheme);
        if (!result.IsSuccess || result.Data is null)
        {
            snackbar.Add($"Erro ao criar produto ({result.Error.Code})", Severity.Error);
            return;
        }

        if (_imageBytes is not null)
        {
            using var memoryStream = new MemoryStream(_imageBytes);
            var imageScheme = new ProductImageStreamScheme
            {
                EstablishmentId = establishment.Identifier,
                ProductId = result.Data.Identifier,
                Stream = memoryStream
            };

            var imageResult = await storeClient.UploadProductImage(imageScheme);
            if (!imageResult.IsSuccess)
            {
                snackbar.Add($"Produto criado, mas houve erro ao fazer upload da imagem ({imageResult.Error.Code})", Severity.Warning);
            }
        }

        snackbar.Add("Produto criado com sucesso!", Severity.Success);

        _model = new();
        ClearImage();
        await OnSuccess.InvokeAsync();

        _isSubmitting = false;
    }
}