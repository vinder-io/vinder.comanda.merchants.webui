@page "/produtos"

@inject IStoreClient storeClient
@inject ILocalStorageGateway localStorage
@inject IDialogService dialogService
@inject ISnackbar snackbar
@inject IConfiguration configuration

<PageTitle>Produtos</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-6 mb-6"
        Style="border-radius: 12px; border-left: 4px solid var(--mud-palette-primary);">
        <div class="d-flex align-center justify-space-between">
            <div class="d-flex align-center">
                <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large"
                    Style="background: rgba(var(--mud-palette-primary-rgb), 0.1);">
                    <MudIcon Icon="@Icons.Material.Outlined.Inventory2" Color="Color.Primary" Size="Size.Medium" />
                </MudAvatar>
                <div class="ml-4">
                    <MudText Typo="Typo.h4" Style="font-weight: 700;">
                        Produtos
                    </MudText>
                    <MudText Typo="Typo.body1" Style="opacity: 0.7; margin-top: 4px;">
                        Gerencie o cardápio do seu estabelecimento
                    </MudText>
                </div>
            </div>
            <div class="d-flex gap-2 align-center">
                <MudIconButton Icon="@Icons.Material.Outlined.Refresh" Color="Color.Inherit" Variant="Variant.Text"
                    Size="Size.Medium" Style="border-radius: 8px; opacity: 0.7; transition: all 0.2s ease;"
                    Class="hover-icon-button" OnClick="@LoadProductsAsync" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Outlined.Add"
                    Style="border-radius: 8px;" OnClick="@HandleAddProduct">
                    Adicionar Produto
                </MudButton>
            </div>
        </div>
    </MudPaper>

    <ProductSearch 
        Title="@_searchTitle"
        MinPrice="@_minPrice"
        MaxPrice="@_maxPrice"
        OnSearch="@HandleSearchAsync" />

    @if (_isLoading)
    {
        <div class="d-flex justify-center align-center pa-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (_paginatedProducts is null)
    {
        <MudAlert Severity="Severity.Warning">Dados de paginação nulos</MudAlert>
    }
    else if (_paginatedProducts.Items is null || !_paginatedProducts.Items.Any())
    {
        <MudPaper Elevation="0" Class="pa-8" Style="border-radius: 12px; text-align: center;">
            <MudIcon Icon="@Icons.Material.Outlined.Inventory2" Color="Color.Default" Size="Size.Large"
                Style="opacity: 0.3; font-size: 4rem;" />
            <MudText Typo="Typo.h6" Style="opacity: 0.6; margin-top: 1rem;">
                Nenhum produto cadastrado
            </MudText>
            <MudText Typo="Typo.body2" Style="opacity: 0.5; margin-top: 0.5rem;">
                Adicione produtos para começar a vender
            </MudText>
        </MudPaper>
    }
    else
    {
        <div class="product-gallery mb-6">
            @foreach (var product in _paginatedProducts.Items)
            {
                <ProductCard ProductId="@product.Identifier" Name="@product.Title" Description="@product.Description"
                    Price="@product.Price" ImageUrl="@GetFullImageUrl(product.Image)" OnEdit="@HandleEditProduct"
                    OnDelete="@HandleDeleteProduct" />
            }
        </div>

        <div class="d-flex justify-center align-center mt-6">
            <MudPagination 
                Count="@_paginatedProducts.TotalPages" 
                Selected="@_paginatedProducts.PageNumber"
                SelectedChanged="@HandlePageChanged"
                Color="Color.Primary" 
                Size="Size.Large" 
                ShowFirstButton="true" 
                ShowLastButton="true" />
        </div>

        <div class="d-flex justify-center mt-3">
            <MudText Typo="Typo.body2" Style="opacity: 0.6;">
                Mostrando @GetStartItem() até @GetEndItem() de @_paginatedProducts.Total itens
            </MudText>
        </div>
    }
</MudContainer>

@code {
    private PaginationScheme<ProductScheme>? _paginatedProducts;
    private bool _isLoading = true;
    private int _currentPage = 0;
    private const int PageSize = 20;
    
    // Filtros de busca
    private string? _searchTitle;
    private decimal? _minPrice;
    private decimal? _maxPrice;

    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync();
    }

    private async Task LoadProductsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        var establishment = await localStorage.GetAsync<EstablishmentScheme>(Storage.Establishment);
        if (establishment is null)
        {
            snackbar.Add("Erro ao identificar o estabelecimento", Severity.Error);
            return;
        }

        var parameters = new ProductsFetchParameters
        {
            EstablishmentId = establishment.Identifier,
            Title = _searchTitle,
            MinPrice = _minPrice,
            MaxPrice = _maxPrice,
            Pagination = PaginationFilters.From(_currentPage + 1, PageSize)
        };

        var result = await storeClient.GetProductsAsync(parameters);
        if (result.IsSuccess && result.Data is not null)
        {
            _paginatedProducts = result.Data;
        }
        else
        {
            snackbar.Add($"Erro ao carregar produtos ({result.Error.Code})", Severity.Error);
        }

        _isLoading = false;
        StateHasChanged();
    }

    private async Task HandleSearchAsync(ProductSearch.SearchFilters filters)
    {
        _searchTitle = filters.Title;
        _minPrice = filters.MinPrice;
        _maxPrice = filters.MaxPrice;
        _currentPage = 0; // Reset para primeira página ao fazer busca
        await LoadProductsAsync();
    }

    private async Task HandlePageChanged(int pageNumber)
    {
        _currentPage = pageNumber - 1;
        await LoadProductsAsync();
    }

    private int GetStartItem()
    {
        if (_paginatedProducts is null || _paginatedProducts.PageNumber < 1) return 0;
        return ((_paginatedProducts.PageNumber - 1) * _paginatedProducts.PageSize) + 1;
    }

    private int GetEndItem()
    {
        if (_paginatedProducts is null) return 0;
        return Math.Min(_paginatedProducts.PageNumber * _paginatedProducts.PageSize, _paginatedProducts.Total);
    }

    private async Task HandleAddProduct()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            Position = DialogPosition.Center
        };

        var dialog = await dialogService.ShowAsync<ProductCreationDialog>("", options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadProductsAsync();
        }
    }

    private void HandleEditProduct(string productId)
    {
        snackbar.Add("Funcionalidade de edição em desenvolvimento", Severity.Info);
    }

    private async Task HandleDeleteProduct(string productId)
    {
        var confirm = await dialogService.ShowMessageBox(
        "Confirmar exclusão",
        "Tem certeza que deseja excluir este produto?",
        yesText: "Excluir",
        cancelText: "Cancelar");

        if (confirm == true)
        {
            snackbar.Add("Funcionalidade de exclusão em desenvolvimento", Severity.Info);
        }
    }

    private string GetFullImageUrl(string imageUrl)
    {
        if (string.IsNullOrEmpty(imageUrl))
            return string.Empty;

        var blobUrl = configuration["Settings:Blob"];
        if (string.IsNullOrEmpty(blobUrl))
            return imageUrl;

        blobUrl = blobUrl.TrimEnd('/');
        imageUrl = imageUrl.TrimStart('/');

        return $"{blobUrl}/{imageUrl}";
    }
}